<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Rotating Kops Etcd Certificates - ivnilv blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Rotating Kops Etcd Certificates">
<meta itemprop="description" content="Rotating kOps etcd certificates Updated 8 Dec 2020 Check etcd-manager version Using kubectl:">
<meta itemprop="datePublished" content="2020-12-08T18:27:01+02:00" />
<meta itemprop="dateModified" content="2020-12-08T18:27:01+02:00" />
<meta itemprop="wordCount" content="503">



<meta itemprop="keywords" content="" />
<meta property="og:title" content="Rotating Kops Etcd Certificates" />
<meta property="og:description" content="Rotating kOps etcd certificates Updated 8 Dec 2020 Check etcd-manager version Using kubectl:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ivnilv.github.io/posts/rotating-kops-etcd-certificates/" />
<meta property="article:published_time" content="2020-12-08T18:27:01+02:00" />
<meta property="article:modified_time" content="2020-12-08T18:27:01+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rotating Kops Etcd Certificates"/>
<meta name="twitter:description" content="Rotating kOps etcd certificates Updated 8 Dec 2020 Check etcd-manager version Using kubectl:"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://ivnilv.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://ivnilv.github.io/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="http://ivnilv.github.io/css/dark.css" />

	<script src="http://ivnilv.github.io/js/feather.min.js"></script>
	
		<script src="http://ivnilv.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="http://ivnilv.github.io/">ivnilv blog</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">08</span>
							<span class="rest">Dec 2020</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Rotating Kops Etcd Certificates</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h3 id="rotating-kops-etcd-certificates"><em>Rotating kOps etcd certificates</em></h3>
<p><!-- raw HTML omitted --><em>Updated 8 Dec 2020</em><!-- raw HTML omitted --></p>
<hr>
<h4 id="check-etcd-manager-version"><em>Check etcd-manager version</em></h4>
<p>Using kubectl:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ k -n kube-system get pod etcd-manager-main-ip-172-20-115-29.eu-central-1.compute.internal -o yaml | grep &#34;image\:&#34;
    image: kopeio/etcd-manager:3.0.20200429
</code></pre></div><p>According to the <a href="https://github.com/kopeio/etcd-manager/releases">releases documentation</a> version 3.0.20200428 brings a fix that renews expiring certificates in the cluster.</p>
<p>However, the implementation of this as noted in github issue <a href="https://github.com/kopeio/etcd-manager/pull/309">#309</a></p>
<blockquote>
<p>Not a perfect fix, if you don&rsquo;t restart things every now and then, they could still expire. But it&rsquo;s at least closer and means if you do restart things, it will fix itself.</p>
</blockquote>
<h4 id="rotating-expired-etcd-client-certificates"><em>Rotating expired etcd client certificates</em></h4>
<p>After the etcd-manager running in the cluster is confirmed to be 3.0.20200428 or above, all that&rsquo;s needed to regenerate the certificates and restore the etcd cluster is restarting the Kubernetes master nodes. You could also restart the etcd main and etcd events pods instead, however we&rsquo;ll go with restarting the whole EC2 instances.</p>
<p>When the restarted instance comes back up it will start the <code>etcd-main</code> and <code>etcd-events</code> pods , which will trigger the startup checks implemented in the <code>etcd-manager</code> code to check the certificates expiration.</p>
<p>If it finds that the certificates are expiring in 60 days or less, it will regenerate them. You should see the following output in the logs for the <code>etcd-main</code> and <code>etcd-events</code> pods:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">etcd-manager
...
I1208 08:37:56.019184   12806 main.go:299] Setting data dir to /rootfs/mnt/master-vol-05229c33cdd57f157
I1208 08:37:56.019648   12806 certs.go:106] existing certificate not valid after 2022-12-08T08:37:05Z; will regenerate
I1208 08:37:56.019655   12806 certs.go:167] generating certificate for &#34;etcd-manager-server-etcd-c&#34;
I1208 08:37:56.023307   12806 certs.go:106] existing certificate not valid after 2022-12-08T08:37:05Z; will regenerate
I1208 08:37:56.023350   12806 certs.go:167] generating certificate for &#34;etcd-manager-client-etcd-c&#34;
...
I1208 08:37:56.032081   12806 pki.go:39] generating peer keypair for etcd: {CommonName:etcd-c Organization:[] AltNames:{DNSNames:[etcd-c.internal.preprod-kubernetes.k8s.local] IPs:[127.0.0.1]} Usages:[2 1]}
I1208 08:37:56.032340   12806 certs.go:106] existing certificate not valid after 2022-12-08T08:37:05Z; will regenerate
I1208 08:37:56.032346   12806 certs.go:167] generating certificate for &#34;etcd-c&#34;
I1208 08:37:56.041521   12806 pki.go:79] building client-serving certificate: {CommonName:etcd-c Organization:[] AltNames:{DNSNames:[etcd-c.internal.preprod-kubernetes.k8s.local etcd-c.internal.preprod-kubernetes.k8s.local] IPs:[127.0.0.1 127.0.0.1]} Usages:[1 2]}
I1208 08:37:56.041786   12806 certs.go:106] existing certificate not valid after 2022-12-08T08:37:05Z; will regenerate
I1208 08:37:56.041795   12806 certs.go:167] generating certificate for &#34;etcd-c&#34;
I1208 08:37:56.499683   12806 certs.go:167] generating certificate for &#34;etcd-manager-etcd-c&#34;
...
I1208 08:37:56.753268   12806 certs.go:167] generating certificate for &#34;etcd-c&#34;
</code></pre></div><p>This needs to be done on all Kubernetes master nodes/etcd pods.</p>
<h4 id="fix-not-working-prometheus-monitoring-after-cert-rotation"><em>Fix not working Prometheus monitoring after cert rotation</em></h4>
<p>Prometheus Operator relies on a predefined secret containing etcd client certificates, key and etcd CA cert. It&rsquo;s pre-configured <a href="https://git.axs-offices.com/sysadmin/k8s-helm-installed/k8s-helm-installed-preprod/-/blob/master/axs-prometheus-operator/values.yaml#L1634">here</a>. However this secret is not updated automatically with the newly generated certs by the <code>etcd-manager</code> and needs to be done manually.</p>
<p>The easiest way for this is to ssh into one of the Kubernetes master nodes and run the following command, but first you need to delete the old secret containing the old etcd client certs:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ kubectl -n axs-monitoring delete secret etcd-certs
</code></pre></div><p>Next, recreate the secret but this time including the newly generated certificates:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ kubectl -n axs-monitoring create secret generic etcd-certs --from-file=ca.crt=/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt --from-file=client.crt=/etc/kubernetes/pki/kube-apiserver/etcd-client.crt --from-file=client.key=/etc/kubernetes/pki/kube-apiserver/etcd-client.key
</code></pre></div><p><!-- raw HTML omitted -->* *replace namespace and secret name accordingly*<!-- raw HTML omitted --></p>
<p>The only thing left is to restart the Prometheus pod so that it mounts the newly created secret containing your renewed etcd client certificates.</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2020  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
